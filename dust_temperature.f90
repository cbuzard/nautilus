!******************************************************************************
! MODULE: dust_temperature
!******************************************************************************
!
! DESCRIPTION: 
!> @brief Module that contains all the routines needed to compute consistently
!! the dust temperature. Only dust_temp is public.
!!\n\n The grain temperature is only a function of UV flux and visual extinction
!!. If those parameters are constant, you only need to calculate the grain 
!! temperature once, during initialisation.
!
!> @warning initial_tdust must be launched one time (and one time alone) before
!! retrieving dust temperature with get_grain_temperature_computed.
!
!******************************************************************************

module dust_temperature

use iso_fortran_env, only : error_unit
use global_variables

implicit none

integer, parameter :: nwlen=5000
real(double_precision), dimension(nwlen) :: wlen
real(double_precision), dimension(nwlen) :: Iinc_dust !< incident dust flux (rayonnement ; TODO)
real(double_precision), dimension(nwlen) :: Qabs
real(double_precision), dimension(nwlen) :: Iinc
real(double_precision) :: rate_abs

private

public :: get_grain_temperature_computed !< Only dust_temp and initialisation routine will be available outside the module.
public :: initial_tdust
contains

!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
SUBROUTINE get_grain_temperature_computed(time, gas_temperature, grain_temperature)

IMPLICIT NONE

! Inputs
real(double_precision), intent(in) :: time !<[in] current time of the simulation [s]
real(double_precision), intent(in) :: gas_temperature !<[in] gas temperature [K]

! Outputs
real(double_precision), intent(out) :: grain_temperature !<[out] Steady state dust temperature [K]

REAL(double_precision)                  :: Tleft, Tright ! Temperature boundary
REAL(double_precision), PARAMETER       :: eps = 1.0D-08 ! Tolerance
REAL(double_precision)                  :: fss           ! Rq: fss should be equal to zero
INTEGER                       :: i
INTEGER                       :: etat          ! flag

! Initialisation is done in nautilus_main:initialisation() only if the flag for grain_temperature is 'computed'

!----
! Compute the incident radiation filed in term of specific
! intensity (erg cm-2 s-1 Angstrom-1 sr-1) after screening 
! by dust
CALL compute_Iinc(wlen,Iinc)

!----
! Compute the absorption rate by dust
CALL compute_abs(wlen,Iinc,Qabs,rate_abs)

!----
! Find the steady state dust temperature using a 
! dichotomy algorithm.

! Temperature boundary
Tleft = 2.73D+00
Tright = 1.0D+03

CALL dicho(Tleft,Tright,eps,grain_temperature,fss,etat)

!----
! Check the dust emission
!~ CALL initial_tdust(wlen,Qabs,Iinc_dust)
!~ OPEN(10,FILE='dust_em.dat',STATUS='unknown')
!~ DO i = 1, nwlen
!~    WRITE(10,*), wlen(i),Qabs(i)*bbody(wlen(i),grain_temperature)
!~ ENDDO
!~ CLOSE(10)

END SUBROUTINE get_grain_temperature_computed
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
SUBROUTINE initial_tdust()

!----
! This subroutine initialise some parameters:
!    - the wavelength in Angstrom
!    - Qabs from Draine calculations
!    - the dust emission intensity from Draine calculations
!
! Draine's calculations are interpolated to the computed wavelength




IMPLICIT NONE

! absorption efficiency Qabs for a 0.1 micrometer grain radius
INTEGER, PARAMETER                         :: nQabs=241
REAL(double_precision), DIMENSION(nQabs)             :: x1 = [& !< Wavelength [micrometers]
1.000D+03, 9.441D+02, 8.913D+02, 8.414D+02, 7.943D+02, 7.499D+02, 7.079D+02, 6.683D+02, 6.310D+02, 5.957D+02, 5.623D+02, &
5.309D+02, 5.012D+02, 4.732D+02, 4.467D+02, 4.217D+02, 3.981D+02, 3.758D+02, 3.548D+02, 3.350D+02, 3.162D+02, 2.985D+02, &
2.818D+02, 2.661D+02, 2.512D+02, 2.371D+02, 2.239D+02, 2.113D+02, 1.995D+02, 1.884D+02, 1.778D+02, 1.679D+02, 1.585D+02, &
1.496D+02, 1.413D+02, 1.334D+02, 1.259D+02, 1.189D+02, 1.122D+02, 1.059D+02, 1.000D+02, 9.441D+01, 8.913D+01, 8.414D+01, &
7.943D+01, 7.499D+01, 7.079D+01, 6.683D+01, 6.310D+01, 5.957D+01, 5.623D+01, 5.309D+01, 5.012D+01, 4.732D+01, 4.467D+01, &
4.217D+01, 3.981D+01, 3.758D+01, 3.548D+01, 3.350D+01, 3.162D+01, 2.985D+01, 2.818D+01, 2.661D+01, 2.512D+01, 2.371D+01, &
2.239D+01, 2.113D+01, 1.995D+01, 1.884D+01, 1.778D+01, 1.679D+01, 1.585D+01, 1.496D+01, 1.413D+01, 1.334D+01, 1.259D+01, &
1.189D+01, 1.122D+01, 1.059D+01, 1.000D+01, 9.441D+00, 8.913D+00, 8.414D+00, 7.943D+00, 7.499D+00, 7.079D+00, 6.683D+00, &
6.310D+00, 5.957D+00, 5.623D+00, 5.309D+00, 5.012D+00, 4.732D+00, 4.467D+00, 4.217D+00, 3.981D+00, 3.758D+00, 3.548D+00, &
3.350D+00, 3.162D+00, 2.985D+00, 2.818D+00, 2.661D+00, 2.512D+00, 2.371D+00, 2.239D+00, 2.113D+00, 1.995D+00, 1.884D+00, &
1.778D+00, 1.679D+00, 1.585D+00, 1.496D+00, 1.413D+00, 1.334D+00, 1.259D+00, 1.189D+00, 1.122D+00, 1.059D+00, 1.000D+00, &
9.441D-01, 8.913D-01, 8.414D-01, 7.943D-01, 7.499D-01, 7.079D-01, 6.683D-01, 6.310D-01, 5.957D-01, 5.623D-01, 5.309D-01, &
5.012D-01, 4.732D-01, 4.467D-01, 4.217D-01, 3.981D-01, 3.758D-01, 3.548D-01, 3.350D-01, 3.162D-01, 2.985D-01, 2.818D-01, &
2.661D-01, 2.512D-01, 2.371D-01, 2.239D-01, 2.113D-01, 1.995D-01, 1.884D-01, 1.778D-01, 1.679D-01, 1.585D-01, 1.496D-01, &
1.413D-01, 1.334D-01, 1.259D-01, 1.189D-01, 1.122D-01, 1.059D-01, 1.000D-01, 9.441D-02, 8.913D-02, 8.414D-02, 7.943D-02, &
7.499D-02, 7.079D-02, 6.683D-02, 6.310D-02, 5.957D-02, 5.623D-02, 5.309D-02, 5.012D-02, 4.732D-02, 4.467D-02, 4.217D-02, &
3.981D-02, 3.758D-02, 3.548D-02, 3.350D-02, 3.162D-02, 2.985D-02, 2.818D-02, 2.661D-02, 2.512D-02, 2.371D-02, 2.239D-02, &
2.113D-02, 1.995D-02, 1.884D-02, 1.778D-02, 1.679D-02, 1.585D-02, 1.496D-02, 1.413D-02, 1.334D-02, 1.259D-02, 1.189D-02, &
1.122D-02, 1.059D-02, 1.000D-02, 9.441D-03, 8.913D-03, 8.414D-03, 7.943D-03, 7.499D-03, 7.079D-03, 6.683D-03, 6.310D-03, &
5.957D-03, 5.623D-03, 5.309D-03, 5.012D-03, 4.732D-03, 4.467D-03, 4.217D-03, 3.981D-03, 3.758D-03, 3.548D-03, 3.350D-03, &
3.162D-03, 2.985D-03, 2.818D-03, 2.661D-03, 2.512D-03, 2.371D-03, 2.239D-03, 2.113D-03, 1.995D-03, 1.884D-03, 1.778D-03, &
1.679D-03, 1.585D-03, 1.496D-03, 1.413D-03, 1.334D-03, 1.259D-03, 1.189D-03, 1.122D-03, 1.059D-03, 1.000D-03]

REAL(double_precision), DIMENSION(nQabs)             :: Qdr = [& !< Q_abs ? unit? TODO
1.371D-05, 1.538D-05, 1.726D-05, 1.936D-05, 2.173D-05, 2.438D-05, 2.736D-05, 3.070D-05, 3.445D-05, 3.866D-05, 4.338D-05, &
4.869D-05, 5.464D-05, 6.132D-05, 6.883D-05, 7.726D-05, 8.671D-05, 9.732D-05, 1.092D-04, 1.226D-04, 1.377D-04, 1.546D-04, &
1.736D-04, 1.949D-04, 2.189D-04, 2.459D-04, 2.763D-04, 3.104D-04, 3.489D-04, 3.920D-04, 4.405D-04, 4.952D-04, 5.569D-04, &
6.264D-04, 7.049D-04, 7.933D-04, 8.930D-04, 1.006D-03, 1.132D-03, 1.277D-03, 1.440D-03, 1.624D-03, 1.833D-03, 2.070D-03, &
2.340D-03, 2.642D-03, 2.989D-03, 3.381D-03, 3.826D-03, 4.327D-03, 4.895D-03, 5.536D-03, 6.253D-03, 7.061D-03, 7.970D-03, &
8.990D-03, 1.012D-02, 1.137D-02, 1.270D-02, 1.422D-02, 1.601D-02, 1.809D-02, 2.039D-02, 2.305D-02, 2.613D-02, 2.954D-02, &
3.354D-02, 3.817D-02, 4.368D-02, 4.857D-02, 4.877D-02, 4.438D-02, 3.796D-02, 3.220D-02, 2.901D-02, 3.468D-02, 4.582D-02, &
6.090D-02, 7.918D-02, 1.045D-01, 1.268D-01, 1.414D-01, 1.051D-01, 6.791D-02, 3.155D-02, 1.402D-02, 1.104D-02, 1.094D-02, &
1.088D-02, 1.064D-02, 1.048D-02, 1.048D-02, 1.063D-02, 1.090D-02, 1.127D-02, 1.171D-02, 1.216D-02, 1.261D-02, 1.310D-02, &
1.361D-02, 1.407D-02, 1.460D-02, 1.519D-02, 1.583D-02, 1.653D-02, 1.730D-02, 1.813D-02, 1.904D-02, 2.003D-02, 2.110D-02, &
2.228D-02, 2.360D-02, 2.508D-02, 2.668D-02, 2.841D-02, 3.030D-02, 3.238D-02, 3.477D-02, 3.741D-02, 4.034D-02, 4.359D-02, &
4.721D-02, 5.123D-02, 5.568D-02, 6.062D-02, 6.611D-02, 7.220D-02, 7.899D-02, 8.665D-02, 9.531D-02, 1.053D-01, 1.170D-01, &
1.314D-01, 1.498D-01, 1.736D-01, 2.035D-01, 2.355D-01, 2.584D-01, 2.626D-01, 2.548D-01, 2.556D-01, 2.849D-01, 3.542D-01, &
4.159D-01, 3.906D-01, 3.485D-01, 4.602D-01, 7.173D-01, 7.966D-01, 1.151D+00, 1.332D+00, 1.420D+00, 1.405D+00, 1.343D+00, &
1.345D+00, 1.336D+00, 1.314D+00, 1.282D+00, 1.261D+00, 1.226D+00, 1.200D+00, 1.176D+00, 1.156D+00, 1.138D+00, 1.101D+00, &
1.053D+00, 1.004D+00, 9.431D-01, 8.698D-01, 8.344D-01, 8.966D-01, 9.201D-01, 9.328D-01, 9.390D-01, 9.414D-01, 9.415D-01, &
9.400D-01, 9.375D-01, 9.344D-01, 9.309D-01, 9.271D-01, 9.233D-01, 9.192D-01, 9.155D-01, 9.117D-01, 9.085D-01, 9.099D-01, &
9.073D-01, 9.062D-01, 9.160D-01, 9.082D-01, 9.032D-01, 8.985D-01, 8.933D-01, 8.876D-01, 8.900D-01, 8.877D-01, 8.774D-01, &
8.675D-01, 9.067D-01, 8.905D-01, 8.772D-01, 8.627D-01, 8.462D-01, 8.275D-01, 8.067D-01, 8.060D-01, 7.817D-01, 7.550D-01, &
7.263D-01, 6.947D-01, 6.615D-01, 6.270D-01, 5.913D-01, 5.547D-01, 5.178D-01, 4.808D-01, 4.441D-01, 4.081D-01, 3.730D-01, &
3.395D-01, 3.081D-01, 2.771D-01, 2.472D-01, 2.206D-01, 1.962D-01, 3.982D-01, 3.655D-01, 3.326D-01, 3.006D-01, 2.698D-01, &
2.407D-01, 3.535D-01, 3.181D-01, 3.107D-01, 2.788D-01, 2.490D-01, 2.213D-01, 1.948D-01, 1.709D-01, 1.490D-01]


! dust emission from Draine & Li 2007 models
INTEGER, PARAMETER                         :: ndustem=1001
REAL(double_precision), DIMENSION(ndustem)           :: x2 = [& !< Wavelength [micrometers]
1.000D+04, 9.908D+03, 9.817D+03, 9.727D+03, 9.638D+03, 9.550D+03, 9.462D+03, 9.376D+03, 9.290D+03, 9.204D+03, 9.120D+03, &
9.036D+03, 8.954D+03, 8.872D+03, 8.790D+03, 8.710D+03, 8.630D+03, 8.551D+03, 8.472D+03, 8.395D+03, 8.318D+03, 8.241D+03, &
8.166D+03, 8.091D+03, 8.017D+03, 7.943D+03, 7.870D+03, 7.798D+03, 7.727D+03, 7.656D+03, 7.586D+03, 7.516D+03, 7.447D+03, &
7.379D+03, 7.311D+03, 7.244D+03, 7.178D+03, 7.112D+03, 7.047D+03, 6.982D+03, 6.918D+03, 6.855D+03, 6.792D+03, 6.730D+03, &
6.668D+03, 6.607D+03, 6.546D+03, 6.486D+03, 6.427D+03, 6.368D+03, 6.310D+03, 6.252D+03, 6.194D+03, 6.138D+03, 6.081D+03, &
6.026D+03, 5.970D+03, 5.916D+03, 5.861D+03, 5.808D+03, 5.754D+03, 5.702D+03, 5.649D+03, 5.598D+03, 5.546D+03, 5.495D+03, &
5.445D+03, 5.395D+03, 5.346D+03, 5.297D+03, 5.248D+03, 5.200D+03, 5.152D+03, 5.105D+03, 5.058D+03, 5.012D+03, 4.966D+03, &
4.920D+03, 4.875D+03, 4.831D+03, 4.786D+03, 4.742D+03, 4.699D+03, 4.656D+03, 4.613D+03, 4.571D+03, 4.529D+03, 4.487D+03, &
4.446D+03, 4.406D+03, 4.365D+03, 4.325D+03, 4.285D+03, 4.246D+03, 4.207D+03, 4.169D+03, 4.130D+03, 4.093D+03, 4.055D+03, &
4.018D+03, 3.981D+03, 3.945D+03, 3.908D+03, 3.873D+03, 3.837D+03, 3.802D+03, 3.767D+03, 3.733D+03, 3.698D+03, 3.664D+03, &
3.631D+03, 3.597D+03, 3.565D+03, 3.532D+03, 3.499D+03, 3.467D+03, 3.436D+03, 3.404D+03, 3.373D+03, 3.342D+03, 3.311D+03, &
3.281D+03, 3.251D+03, 3.221D+03, 3.192D+03, 3.162D+03, 3.133D+03, 3.105D+03, 3.076D+03, 3.048D+03, 3.020D+03, 2.992D+03, &
2.965D+03, 2.938D+03, 2.911D+03, 2.884D+03, 2.858D+03, 2.831D+03, 2.805D+03, 2.780D+03, 2.754D+03, 2.729D+03, 2.704D+03, &
2.679D+03, 2.655D+03, 2.630D+03, 2.606D+03, 2.582D+03, 2.559D+03, 2.535D+03, 2.512D+03, 2.489D+03, 2.466D+03, 2.443D+03, &
2.421D+03, 2.399D+03, 2.377D+03, 2.355D+03, 2.333D+03, 2.312D+03, 2.291D+03, 2.270D+03, 2.249D+03, 2.228D+03, 2.208D+03, &
2.188D+03, 2.168D+03, 2.148D+03, 2.128D+03, 2.109D+03, 2.089D+03, 2.070D+03, 2.051D+03, 2.032D+03, 2.014D+03, 1.995D+03, &
1.977D+03, 1.959D+03, 1.941D+03, 1.923D+03, 1.905D+03, 1.888D+03, 1.871D+03, 1.854D+03, 1.837D+03, 1.820D+03, 1.803D+03, &
1.786D+03, 1.770D+03, 1.754D+03, 1.738D+03, 1.722D+03, 1.706D+03, 1.690D+03, 1.675D+03, 1.660D+03, 1.644D+03, 1.629D+03, &
1.614D+03, 1.600D+03, 1.585D+03, 1.570D+03, 1.556D+03, 1.542D+03, 1.528D+03, 1.514D+03, 1.500D+03, 1.486D+03, 1.472D+03, &
1.459D+03, 1.445D+03, 1.432D+03, 1.419D+03, 1.406D+03, 1.393D+03, 1.380D+03, 1.368D+03, 1.355D+03, 1.343D+03, 1.330D+03, &
1.318D+03, 1.306D+03, 1.294D+03, 1.282D+03, 1.271D+03, 1.259D+03, 1.247D+03, 1.236D+03, 1.225D+03, 1.213D+03, 1.202D+03, &
1.191D+03, 1.180D+03, 1.169D+03, 1.159D+03, 1.148D+03, 1.138D+03, 1.127D+03, 1.117D+03, 1.107D+03, 1.096D+03, 1.086D+03, &
1.076D+03, 1.067D+03, 1.057D+03, 1.047D+03, 1.038D+03, 1.028D+03, 1.019D+03, 1.009D+03, 1.000D+03, 9.908D+02, 9.817D+02, &
9.727D+02, 9.638D+02, 9.550D+02, 9.462D+02, 9.376D+02, 9.290D+02, 9.204D+02, 9.120D+02, 9.036D+02, 8.954D+02, 8.872D+02, &
8.790D+02, 8.710D+02, 8.630D+02, 8.551D+02, 8.472D+02, 8.395D+02, 8.318D+02, 8.241D+02, 8.166D+02, 8.091D+02, 8.017D+02, &
7.943D+02, 7.870D+02, 7.798D+02, 7.727D+02, 7.656D+02, 7.586D+02, 7.516D+02, 7.447D+02, 7.379D+02, 7.311D+02, 7.244D+02, &
7.178D+02, 7.112D+02, 7.047D+02, 6.982D+02, 6.918D+02, 6.855D+02, 6.792D+02, 6.730D+02, 6.668D+02, 6.607D+02, 6.546D+02, &
6.486D+02, 6.427D+02, 6.368D+02, 6.310D+02, 6.252D+02, 6.194D+02, 6.138D+02, 6.081D+02, 6.026D+02, 5.970D+02, 5.916D+02, &
5.861D+02, 5.808D+02, 5.754D+02, 5.702D+02, 5.649D+02, 5.598D+02, 5.546D+02, 5.495D+02, 5.445D+02, 5.395D+02, 5.346D+02, &
5.297D+02, 5.248D+02, 5.200D+02, 5.152D+02, 5.105D+02, 5.058D+02, 5.012D+02, 4.966D+02, 4.920D+02, 4.875D+02, 4.831D+02, &
4.786D+02, 4.742D+02, 4.699D+02, 4.656D+02, 4.613D+02, 4.571D+02, 4.529D+02, 4.487D+02, 4.446D+02, 4.406D+02, 4.365D+02, &
4.325D+02, 4.285D+02, 4.246D+02, 4.207D+02, 4.169D+02, 4.130D+02, 4.093D+02, 4.055D+02, 4.018D+02, 3.981D+02, 3.945D+02, &
3.908D+02, 3.873D+02, 3.837D+02, 3.802D+02, 3.767D+02, 3.733D+02, 3.698D+02, 3.664D+02, 3.631D+02, 3.597D+02, 3.565D+02, &
3.532D+02, 3.499D+02, 3.467D+02, 3.436D+02, 3.404D+02, 3.373D+02, 3.342D+02, 3.311D+02, 3.281D+02, 3.251D+02, 3.221D+02, &
3.192D+02, 3.162D+02, 3.133D+02, 3.105D+02, 3.076D+02, 3.048D+02, 3.020D+02, 2.992D+02, 2.965D+02, 2.938D+02, 2.911D+02, &
2.884D+02, 2.858D+02, 2.831D+02, 2.805D+02, 2.780D+02, 2.754D+02, 2.729D+02, 2.704D+02, 2.679D+02, 2.655D+02, 2.630D+02, &
2.606D+02, 2.582D+02, 2.559D+02, 2.535D+02, 2.512D+02, 2.489D+02, 2.466D+02, 2.443D+02, 2.421D+02, 2.399D+02, 2.377D+02, &
2.355D+02, 2.333D+02, 2.312D+02, 2.291D+02, 2.270D+02, 2.249D+02, 2.228D+02, 2.208D+02, 2.188D+02, 2.168D+02, 2.148D+02, &
2.128D+02, 2.109D+02, 2.089D+02, 2.070D+02, 2.051D+02, 2.032D+02, 2.014D+02, 1.995D+02, 1.977D+02, 1.959D+02, 1.941D+02, &
1.923D+02, 1.905D+02, 1.888D+02, 1.871D+02, 1.854D+02, 1.837D+02, 1.820D+02, 1.803D+02, 1.786D+02, 1.770D+02, 1.754D+02, &
1.738D+02, 1.722D+02, 1.706D+02, 1.690D+02, 1.675D+02, 1.660D+02, 1.644D+02, 1.629D+02, 1.614D+02, 1.600D+02, 1.585D+02, &
1.570D+02, 1.556D+02, 1.542D+02, 1.528D+02, 1.514D+02, 1.500D+02, 1.486D+02, 1.472D+02, 1.459D+02, 1.445D+02, 1.432D+02, &
1.419D+02, 1.406D+02, 1.393D+02, 1.380D+02, 1.368D+02, 1.355D+02, 1.343D+02, 1.330D+02, 1.318D+02, 1.306D+02, 1.294D+02, &
1.282D+02, 1.271D+02, 1.259D+02, 1.247D+02, 1.236D+02, 1.225D+02, 1.213D+02, 1.202D+02, 1.191D+02, 1.180D+02, 1.169D+02, &
1.159D+02, 1.148D+02, 1.138D+02, 1.127D+02, 1.117D+02, 1.107D+02, 1.096D+02, 1.086D+02, 1.076D+02, 1.067D+02, 1.057D+02, &
1.047D+02, 1.038D+02, 1.028D+02, 1.019D+02, 1.009D+02, 1.000D+02, 9.908D+01, 9.817D+01, 9.727D+01, 9.638D+01, 9.550D+01, &
9.462D+01, 9.376D+01, 9.290D+01, 9.204D+01, 9.120D+01, 9.036D+01, 8.954D+01, 8.872D+01, 8.790D+01, 8.710D+01, 8.630D+01, &
8.551D+01, 8.472D+01, 8.395D+01, 8.318D+01, 8.241D+01, 8.166D+01, 8.091D+01, 8.017D+01, 7.943D+01, 7.870D+01, 7.798D+01, &
7.727D+01, 7.656D+01, 7.586D+01, 7.516D+01, 7.447D+01, 7.379D+01, 7.311D+01, 7.244D+01, 7.178D+01, 7.112D+01, 7.047D+01, &
6.982D+01, 6.918D+01, 6.855D+01, 6.792D+01, 6.730D+01, 6.668D+01, 6.607D+01, 6.546D+01, 6.486D+01, 6.427D+01, 6.368D+01, &
6.310D+01, 6.252D+01, 6.194D+01, 6.138D+01, 6.081D+01, 6.026D+01, 5.970D+01, 5.916D+01, 5.861D+01, 5.808D+01, 5.754D+01, &
5.702D+01, 5.649D+01, 5.598D+01, 5.546D+01, 5.495D+01, 5.445D+01, 5.395D+01, 5.346D+01, 5.297D+01, 5.248D+01, 5.200D+01, &
5.152D+01, 5.105D+01, 5.058D+01, 5.012D+01, 4.966D+01, 4.920D+01, 4.875D+01, 4.831D+01, 4.786D+01, 4.742D+01, 4.699D+01, &
4.656D+01, 4.613D+01, 4.571D+01, 4.529D+01, 4.487D+01, 4.446D+01, 4.406D+01, 4.365D+01, 4.325D+01, 4.285D+01, 4.246D+01, &
4.207D+01, 4.169D+01, 4.130D+01, 4.093D+01, 4.055D+01, 4.018D+01, 3.981D+01, 3.945D+01, 3.908D+01, 3.873D+01, 3.837D+01, &
3.802D+01, 3.767D+01, 3.733D+01, 3.698D+01, 3.664D+01, 3.631D+01, 3.597D+01, 3.565D+01, 3.532D+01, 3.499D+01, 3.467D+01, &
3.436D+01, 3.404D+01, 3.373D+01, 3.342D+01, 3.311D+01, 3.281D+01, 3.251D+01, 3.221D+01, 3.192D+01, 3.162D+01, 3.133D+01, &
3.105D+01, 3.076D+01, 3.048D+01, 3.020D+01, 2.992D+01, 2.965D+01, 2.938D+01, 2.911D+01, 2.884D+01, 2.858D+01, 2.831D+01, &
2.805D+01, 2.780D+01, 2.754D+01, 2.729D+01, 2.704D+01, 2.679D+01, 2.655D+01, 2.630D+01, 2.606D+01, 2.582D+01, 2.559D+01, &
2.535D+01, 2.512D+01, 2.489D+01, 2.466D+01, 2.443D+01, 2.421D+01, 2.399D+01, 2.377D+01, 2.355D+01, 2.333D+01, 2.312D+01, &
2.291D+01, 2.270D+01, 2.249D+01, 2.228D+01, 2.208D+01, 2.188D+01, 2.168D+01, 2.148D+01, 2.128D+01, 2.109D+01, 2.089D+01, &
2.070D+01, 2.051D+01, 2.032D+01, 2.014D+01, 1.995D+01, 1.977D+01, 1.959D+01, 1.941D+01, 1.923D+01, 1.905D+01, 1.888D+01, &
1.871D+01, 1.854D+01, 1.837D+01, 1.820D+01, 1.803D+01, 1.786D+01, 1.770D+01, 1.754D+01, 1.738D+01, 1.722D+01, 1.706D+01, &
1.690D+01, 1.675D+01, 1.660D+01, 1.644D+01, 1.629D+01, 1.614D+01, 1.600D+01, 1.585D+01, 1.570D+01, 1.556D+01, 1.542D+01, &
1.528D+01, 1.514D+01, 1.500D+01, 1.486D+01, 1.472D+01, 1.459D+01, 1.445D+01, 1.432D+01, 1.419D+01, 1.406D+01, 1.393D+01, &
1.380D+01, 1.368D+01, 1.355D+01, 1.343D+01, 1.330D+01, 1.318D+01, 1.306D+01, 1.294D+01, 1.282D+01, 1.271D+01, 1.259D+01, &
1.247D+01, 1.236D+01, 1.225D+01, 1.213D+01, 1.202D+01, 1.191D+01, 1.180D+01, 1.169D+01, 1.159D+01, 1.148D+01, 1.138D+01, &
1.127D+01, 1.117D+01, 1.107D+01, 1.096D+01, 1.086D+01, 1.076D+01, 1.067D+01, 1.057D+01, 1.047D+01, 1.038D+01, 1.028D+01, &
1.019D+01, 1.009D+01, 1.000D+01, 9.908D+00, 9.817D+00, 9.727D+00, 9.638D+00, 9.550D+00, 9.462D+00, 9.376D+00, 9.290D+00, &
9.204D+00, 9.120D+00, 9.036D+00, 8.954D+00, 8.872D+00, 8.790D+00, 8.710D+00, 8.630D+00, 8.551D+00, 8.472D+00, 8.395D+00, &
8.318D+00, 8.241D+00, 8.166D+00, 8.091D+00, 8.017D+00, 7.943D+00, 7.870D+00, 7.798D+00, 7.727D+00, 7.656D+00, 7.586D+00, &
7.516D+00, 7.447D+00, 7.379D+00, 7.311D+00, 7.244D+00, 7.178D+00, 7.112D+00, 7.047D+00, 6.982D+00, 6.918D+00, 6.855D+00, &
6.792D+00, 6.730D+00, 6.668D+00, 6.607D+00, 6.546D+00, 6.486D+00, 6.427D+00, 6.368D+00, 6.310D+00, 6.252D+00, 6.194D+00, &
6.138D+00, 6.081D+00, 6.026D+00, 5.970D+00, 5.916D+00, 5.861D+00, 5.808D+00, 5.754D+00, 5.702D+00, 5.649D+00, 5.598D+00, &
5.546D+00, 5.495D+00, 5.445D+00, 5.395D+00, 5.346D+00, 5.297D+00, 5.248D+00, 5.200D+00, 5.152D+00, 5.105D+00, 5.058D+00, &
5.012D+00, 4.966D+00, 4.920D+00, 4.875D+00, 4.831D+00, 4.786D+00, 4.742D+00, 4.699D+00, 4.656D+00, 4.613D+00, 4.571D+00, &
4.529D+00, 4.487D+00, 4.446D+00, 4.406D+00, 4.365D+00, 4.325D+00, 4.285D+00, 4.246D+00, 4.207D+00, 4.169D+00, 4.130D+00, &
4.093D+00, 4.055D+00, 4.018D+00, 3.981D+00, 3.945D+00, 3.908D+00, 3.873D+00, 3.837D+00, 3.802D+00, 3.767D+00, 3.733D+00, &
3.698D+00, 3.664D+00, 3.631D+00, 3.597D+00, 3.565D+00, 3.532D+00, 3.499D+00, 3.467D+00, 3.436D+00, 3.404D+00, 3.373D+00, &
3.342D+00, 3.311D+00, 3.281D+00, 3.251D+00, 3.221D+00, 3.192D+00, 3.162D+00, 3.133D+00, 3.105D+00, 3.076D+00, 3.048D+00, &
3.020D+00, 2.992D+00, 2.965D+00, 2.938D+00, 2.911D+00, 2.884D+00, 2.858D+00, 2.831D+00, 2.805D+00, 2.780D+00, 2.754D+00, &
2.729D+00, 2.704D+00, 2.679D+00, 2.655D+00, 2.630D+00, 2.606D+00, 2.582D+00, 2.559D+00, 2.535D+00, 2.512D+00, 2.489D+00, &
2.466D+00, 2.443D+00, 2.421D+00, 2.399D+00, 2.377D+00, 2.355D+00, 2.333D+00, 2.312D+00, 2.291D+00, 2.270D+00, 2.249D+00, &
2.228D+00, 2.208D+00, 2.188D+00, 2.168D+00, 2.148D+00, 2.128D+00, 2.109D+00, 2.089D+00, 2.070D+00, 2.051D+00, 2.032D+00, &
2.014D+00, 1.995D+00, 1.977D+00, 1.959D+00, 1.941D+00, 1.923D+00, 1.905D+00, 1.888D+00, 1.871D+00, 1.854D+00, 1.837D+00, &
1.820D+00, 1.803D+00, 1.786D+00, 1.770D+00, 1.754D+00, 1.738D+00, 1.722D+00, 1.706D+00, 1.690D+00, 1.675D+00, 1.660D+00, &
1.644D+00, 1.629D+00, 1.614D+00, 1.600D+00, 1.585D+00, 1.570D+00, 1.556D+00, 1.542D+00, 1.528D+00, 1.514D+00, 1.500D+00, &
1.486D+00, 1.472D+00, 1.459D+00, 1.445D+00, 1.432D+00, 1.419D+00, 1.406D+00, 1.393D+00, 1.380D+00, 1.368D+00, 1.355D+00, &
1.343D+00, 1.330D+00, 1.318D+00, 1.306D+00, 1.294D+00, 1.282D+00, 1.271D+00, 1.259D+00, 1.247D+00, 1.236D+00, 1.225D+00, &
1.213D+00, 1.202D+00, 1.191D+00, 1.180D+00, 1.169D+00, 1.159D+00, 1.148D+00, 1.138D+00, 1.127D+00, 1.117D+00, 1.107D+00, &
1.096D+00, 1.086D+00, 1.076D+00, 1.067D+00, 1.057D+00, 1.047D+00, 1.038D+00, 1.028D+00, 1.019D+00, 1.009D+00, 1.000D+00]

REAL(double_precision), DIMENSION(ndustem)           :: Idustdr = [& !< nu*dP/dnu [erg s-1 H-1]
5.303D-31, 5.497D-31, 5.697D-31, 5.905D-31, 6.120D-31, 6.344D-31, 6.575D-31, 6.815D-31, 7.063D-31, 7.321D-31, 7.588D-31, &
7.865D-31, 8.151D-31, 8.446D-31, 8.753D-31, 9.071D-31, 9.400D-31, 9.742D-31, 1.010D-30, 1.046D-30, 1.084D-30, 1.124D-30, &
1.165D-30, 1.207D-30, 1.252D-30, 1.297D-30, 1.345D-30, 1.394D-30, 1.445D-30, 1.498D-30, 1.553D-30, 1.610D-30, 1.669D-30, &
1.730D-30, 1.793D-30, 1.859D-30, 1.928D-30, 1.999D-30, 2.072D-30, 2.148D-30, 2.227D-30, 2.309D-30, 2.394D-30, 2.482D-30, &
2.574D-30, 2.669D-30, 2.767D-30, 2.870D-30, 2.976D-30, 3.086D-30, 3.200D-30, 3.318D-30, 3.441D-30, 3.569D-30, 3.701D-30, &
3.839D-30, 3.981D-30, 4.129D-30, 4.283D-30, 4.442D-30, 4.607D-30, 4.779D-30, 4.957D-30, 5.142D-30, 5.334D-30, 5.533D-30, &
5.740D-30, 5.954D-30, 6.177D-30, 6.408D-30, 6.648D-30, 6.897D-30, 7.155D-30, 7.423D-30, 7.702D-30, 7.991D-30, 8.291D-30, &
8.602D-30, 8.925D-30, 9.261D-30, 9.609D-30, 9.971D-30, 1.035D-29, 1.074D-29, 1.114D-29, 1.156D-29, 1.200D-29, 1.245D-29, &
1.292D-29, 1.341D-29, 1.392D-29, 1.445D-29, 1.499D-29, 1.556D-29, 1.615D-29, 1.676D-29, 1.740D-29, 1.806D-29, 1.875D-29, &
1.946D-29, 2.020D-29, 2.097D-29, 2.177D-29, 2.260D-29, 2.346D-29, 2.435D-29, 2.528D-29, 2.625D-29, 2.725D-29, 2.829D-29, &
2.938D-29, 3.050D-29, 3.167D-29, 3.288D-29, 3.414D-29, 3.546D-29, 3.682D-29, 3.823D-29, 3.970D-29, 4.123D-29, 4.282D-29, &
4.447D-29, 4.618D-29, 4.797D-29, 4.982D-29, 5.174D-29, 5.374D-29, 5.582D-29, 5.798D-29, 6.022D-29, 6.256D-29, 6.498D-29, &
6.749D-29, 7.010D-29, 7.281D-29, 7.563D-29, 7.856D-29, 8.161D-29, 8.477D-29, 8.806D-29, 9.148D-29, 9.504D-29, 9.874D-29, &
1.026D-28, 1.066D-28, 1.107D-28, 1.150D-28, 1.195D-28, 1.242D-28, 1.290D-28, 1.341D-28, 1.393D-28, 1.448D-28, 1.504D-28, &
1.563D-28, 1.624D-28, 1.688D-28, 1.754D-28, 1.823D-28, 1.894D-28, 1.969D-28, 2.046D-28, 2.126D-28, 2.210D-28, 2.297D-28, &
2.387D-28, 2.481D-28, 2.578D-28, 2.680D-28, 2.785D-28, 2.895D-28, 3.009D-28, 3.127D-28, 3.250D-28, 3.378D-28, 3.512D-28, &
3.650D-28, 3.794D-28, 3.943D-28, 4.099D-28, 4.260D-28, 4.428D-28, 4.603D-28, 4.785D-28, 4.973D-28, 5.170D-28, 5.374D-28, &
5.586D-28, 5.807D-28, 6.036D-28, 6.274D-28, 6.522D-28, 6.780D-28, 7.047D-28, 7.326D-28, 7.615D-28, 7.916D-28, 8.228D-28, &
8.553D-28, 8.891D-28, 9.242D-28, 9.607D-28, 9.986D-28, 1.038D-27, 1.079D-27, 1.122D-27, 1.166D-27, 1.212D-27, 1.260D-27, &
1.309D-27, 1.361D-27, 1.415D-27, 1.471D-27, 1.529D-27, 1.589D-27, 1.651D-27, 1.717D-27, 1.784D-27, 1.854D-27, 1.928D-27, &
2.003D-27, 2.082D-27, 2.164D-27, 2.249D-27, 2.338D-27, 2.429D-27, 2.525D-27, 2.624D-27, 2.727D-27, 2.834D-27, 2.945D-27, &
3.060D-27, 3.180D-27, 3.304D-27, 3.433D-27, 3.568D-27, 3.707D-27, 3.852D-27, 4.002D-27, 4.158D-27, 4.320D-27, 4.488D-27, &
4.662D-27, 4.843D-27, 5.031D-27, 5.227D-27, 5.429D-27, 5.639D-27, 5.857D-27, 6.084D-27, 6.319D-27, 6.563D-27, 6.816D-27, &
7.079D-27, 7.352D-27, 7.635D-27, 7.929D-27, 8.234D-27, 8.550D-27, 8.878D-27, 9.218D-27, 9.571D-27, 9.936D-27, 1.032D-26, &
1.071D-26, 1.112D-26, 1.154D-26, 1.198D-26, 1.243D-26, 1.290D-26, 1.339D-26, 1.389D-26, 1.442D-26, 1.496D-26, 1.552D-26, &
1.610D-26, 1.671D-26, 1.733D-26, 1.798D-26, 1.865D-26, 1.934D-26, 2.006D-26, 2.081D-26, 2.158D-26, 2.238D-26, 2.322D-26, &
2.408D-26, 2.497D-26, 2.589D-26, 2.685D-26, 2.784D-26, 2.887D-26, 2.993D-26, 3.103D-26, 3.217D-26, 3.335D-26, 3.457D-26, &
3.584D-26, 3.715D-26, 3.851D-26, 3.992D-26, 4.138D-26, 4.290D-26, 4.446D-26, 4.608D-26, 4.776D-26, 4.950D-26, 5.129D-26, &
5.315D-26, 5.508D-26, 5.707D-26, 5.914D-26, 6.127D-26, 6.348D-26, 6.577D-26, 6.813D-26, 7.058D-26, 7.311D-26, 7.573D-26, &
7.844D-26, 8.125D-26, 8.414D-26, 8.714D-26, 9.024D-26, 9.344D-26, 9.675D-26, 1.002D-25, 1.037D-25, 1.074D-25, 1.111D-25, &
1.151D-25, 1.191D-25, 1.232D-25, 1.276D-25, 1.320D-25, 1.366D-25, 1.413D-25, 1.462D-25, 1.513D-25, 1.565D-25, 1.619D-25, &
1.674D-25, 1.731D-25, 1.791D-25, 1.852D-25, 1.915D-25, 1.979D-25, 2.046D-25, 2.115D-25, 2.187D-25, 2.260D-25, 2.336D-25, &
2.414D-25, 2.494D-25, 2.577D-25, 2.662D-25, 2.750D-25, 2.840D-25, 2.933D-25, 3.029D-25, 3.128D-25, 3.229D-25, 3.334D-25, &
3.441D-25, 3.552D-25, 3.665D-25, 3.782D-25, 3.902D-25, 4.026D-25, 4.153D-25, 4.283D-25, 4.417D-25, 4.554D-25, 4.695D-25, &
4.840D-25, 4.988D-25, 5.141D-25, 5.297D-25, 5.457D-25, 5.622D-25, 5.790D-25, 5.963D-25, 6.139D-25, 6.320D-25, 6.505D-25, &
6.695D-25, 6.889D-25, 7.088D-25, 7.291D-25, 7.499D-25, 7.711D-25, 7.929D-25, 8.151D-25, 8.379D-25, 8.611D-25, 8.848D-25, &
9.091D-25, 9.338D-25, 9.589D-25, 9.843D-25, 1.010D-24, 1.036D-24, 1.062D-24, 1.087D-24, 1.114D-24, 1.140D-24, 1.166D-24, &
1.192D-24, 1.219D-24, 1.246D-24, 1.274D-24, 1.301D-24, 1.329D-24, 1.357D-24, 1.386D-24, 1.415D-24, 1.444D-24, 1.473D-24, &
1.503D-24, 1.532D-24, 1.562D-24, 1.592D-24, 1.622D-24, 1.653D-24, 1.683D-24, 1.714D-24, 1.745D-24, 1.776D-24, 1.807D-24, &
1.838D-24, 1.869D-24, 1.900D-24, 1.931D-24, 1.963D-24, 1.994D-24, 2.025D-24, 2.056D-24, 2.088D-24, 2.119D-24, 2.150D-24, &
2.182D-24, 2.213D-24, 2.244D-24, 2.276D-24, 2.307D-24, 2.338D-24, 2.370D-24, 2.402D-24, 2.433D-24, 2.465D-24, 2.497D-24, &
2.529D-24, 2.561D-24, 2.594D-24, 2.627D-24, 2.660D-24, 2.694D-24, 2.727D-24, 2.759D-24, 2.791D-24, 2.821D-24, 2.848D-24, &
2.872D-24, 2.891D-24, 2.905D-24, 2.912D-24, 2.914D-24, 2.911D-24, 2.904D-24, 2.895D-24, 2.885D-24, 2.874D-24, 2.862D-24, &
2.851D-24, 2.839D-24, 2.827D-24, 2.816D-24, 2.805D-24, 2.794D-24, 2.783D-24, 2.771D-24, 2.760D-24, 2.748D-24, 2.736D-24, &
2.723D-24, 2.709D-24, 2.696D-24, 2.682D-24, 2.667D-24, 2.653D-24, 2.637D-24, 2.621D-24, 2.605D-24, 2.587D-24, 2.570D-24, &
2.551D-24, 2.532D-24, 2.512D-24, 2.491D-24, 2.470D-24, 2.448D-24, 2.424D-24, 2.401D-24, 2.376D-24, 2.351D-24, 2.326D-24, &
2.300D-24, 2.273D-24, 2.246D-24, 2.218D-24, 2.190D-24, 2.161D-24, 2.132D-24, 2.102D-24, 2.072D-24, 2.042D-24, 2.011D-24, &
1.980D-24, 1.948D-24, 1.917D-24, 1.885D-24, 1.853D-24, 1.822D-24, 1.790D-24, 1.758D-24, 1.726D-24, 1.694D-24, 1.661D-24, &
1.629D-24, 1.597D-24, 1.565D-24, 1.533D-24, 1.502D-24, 1.469D-24, 1.438D-24, 1.406D-24, 1.375D-24, 1.344D-24, 1.314D-24, &
1.284D-24, 1.255D-24, 1.226D-24, 1.197D-24, 1.168D-24, 1.140D-24, 1.113D-24, 1.085D-24, 1.059D-24, 1.033D-24, 1.007D-24, &
9.819D-25, 9.574D-25, 9.336D-25, 9.102D-25, 8.874D-25, 8.650D-25, 8.431D-25, 8.220D-25, 8.012D-25, 7.811D-25, 7.617D-25, &
7.429D-25, 7.246D-25, 7.070D-25, 6.898D-25, 6.733D-25, 6.574D-25, 6.420D-25, 6.272D-25, 6.127D-25, 5.990D-25, 5.856D-25, &
5.730D-25, 5.604D-25, 5.487D-25, 5.373D-25, 5.266D-25, 5.164D-25, 5.064D-25, 4.970D-25, 4.881D-25, 4.796D-25, 4.714D-25, &
4.635D-25, 4.561D-25, 4.490D-25, 4.422D-25, 4.359D-25, 4.297D-25, 4.237D-25, 4.181D-25, 4.129D-25, 4.077D-25, 4.027D-25, &
3.980D-25, 3.936D-25, 3.893D-25, 3.852D-25, 3.812D-25, 3.774D-25, 3.737D-25, 3.702D-25, 3.668D-25, 3.634D-25, 3.601D-25, &
3.568D-25, 3.535D-25, 3.503D-25, 3.472D-25, 3.442D-25, 3.411D-25, 3.378D-25, 3.349D-25, 3.319D-25, 3.289D-25, 3.258D-25, &
3.229D-25, 3.200D-25, 3.170D-25, 3.141D-25, 3.113D-25, 3.086D-25, 3.057D-25, 3.030D-25, 3.003D-25, 2.976D-25, 2.951D-25, &
2.924D-25, 2.900D-25, 2.877D-25, 2.854D-25, 2.833D-25, 2.811D-25, 2.792D-25, 2.773D-25, 2.755D-25, 2.739D-25, 2.724D-25, &
2.711D-25, 2.699D-25, 2.689D-25, 2.677D-25, 2.670D-25, 2.664D-25, 2.658D-25, 2.654D-25, 2.650D-25, 2.649D-25, 2.649D-25, &
2.651D-25, 2.654D-25, 2.658D-25, 2.663D-25, 2.669D-25, 2.677D-25, 2.686D-25, 2.696D-25, 2.708D-25, 2.721D-25, 2.736D-25, &
2.750D-25, 2.767D-25, 2.786D-25, 2.806D-25, 2.827D-25, 2.848D-25, 2.870D-25, 2.895D-25, 2.920D-25, 2.947D-25, 2.975D-25, &
3.005D-25, 3.036D-25, 3.069D-25, 3.105D-25, 3.144D-25, 3.187D-25, 3.235D-25, 3.295D-25, 3.385D-25, 3.569D-25, 3.728D-25, &
3.599D-25, 3.588D-25, 3.646D-25, 3.753D-25, 3.942D-25, 4.242D-25, 4.329D-25, 4.640D-25, 5.326D-25, 5.299D-25, 5.380D-25, &
5.294D-25, 5.108D-25, 5.229D-25, 6.084D-25, 4.723D-25, 4.180D-25, 4.008D-25, 3.906D-25, 3.785D-25, 3.715D-25, 3.673D-25, &
3.646D-25, 3.630D-25, 3.625D-25, 3.632D-25, 3.657D-25, 3.715D-25, 3.840D-25, 4.114D-25, 4.428D-25, 4.296D-25, 4.255D-25, &
4.478D-25, 4.957D-25, 5.564D-25, 5.753D-25, 5.476D-25, 5.359D-25, 5.661D-25, 6.492D-25, 8.001D-25, 9.920D-25, 1.059D-24, &
9.306D-25, 7.967D-25, 7.531D-25, 7.919D-25, 8.467D-25, 8.193D-25, 7.453D-25, 7.279D-25, 8.264D-25, 1.116D-24, 1.603D-24, &
2.137D-24, 1.513D-24, 7.831D-25, 5.408D-25, 4.294D-25, 3.708D-25, 3.365D-25, 3.068D-25, 2.872D-25, 2.743D-25, 2.653D-25, &
2.589D-25, 2.547D-25, 2.521D-25, 2.512D-25, 2.519D-25, 2.540D-25, 2.577D-25, 2.631D-25, 2.704D-25, 2.801D-25, 2.929D-25, &
3.103D-25, 3.344D-25, 3.690D-25, 4.212D-25, 5.038D-25, 6.393D-25, 8.465D-25, 1.041D-24, 1.019D-24, 8.867D-25, 8.194D-25, &
8.161D-25, 8.523D-25, 9.424D-25, 1.114D-24, 1.386D-24, 1.744D-24, 2.058D-24, 2.172D-24, 2.188D-24, 2.260D-24, 2.203D-24, &
1.856D-24, 1.464D-24, 1.177D-24, 9.772D-25, 8.315D-25, 7.202D-25, 6.347D-25, 5.714D-25, 5.285D-25, 5.051D-25, 4.996D-25, &
5.067D-25, 5.141D-25, 5.072D-25, 4.860D-25, 4.687D-25, 4.784D-25, 5.413D-25, 7.065D-25, 1.077D-24, 1.676D-24, 1.698D-24, &
1.058D-24, 6.306D-25, 4.202D-25, 3.135D-25, 2.578D-25, 2.331D-25, 2.352D-25, 2.640D-25, 2.844D-25, 2.398D-25, 1.826D-25, &
1.474D-25, 1.287D-25, 1.206D-25, 1.219D-25, 1.352D-25, 1.570D-25, 1.535D-25, 1.218D-25, 9.712D-26, 8.282D-26, 7.421D-26, &
6.854D-26, 6.447D-26, 6.136D-26, 5.887D-26, 5.681D-26, 5.506D-26, 5.354D-26, 5.221D-26, 5.103D-26, 4.997D-26, 4.902D-26, &
4.815D-26, 4.736D-26, 4.664D-26, 4.598D-26, 4.537D-26, 4.482D-26, 4.431D-26, 4.384D-26, 4.342D-26, 4.303D-26, 4.269D-26, &
4.238D-26, 4.211D-26, 4.187D-26, 4.169D-26, 4.155D-26, 4.146D-26, 4.144D-26, 4.149D-26, 4.162D-26, 4.187D-26, 4.225D-26, &
4.280D-26, 4.359D-26, 4.470D-26, 4.627D-26, 4.852D-26, 5.184D-26, 5.691D-26, 6.510D-26, 7.946D-26, 1.078D-25, 1.755D-25, &
3.999D-25, 1.513D-24, 1.033D-24, 2.951D-25, 1.409D-25, 8.991D-26, 6.738D-26, 5.552D-26, 4.851D-26, 4.400D-26, 4.091D-26, &
3.868D-26, 3.700D-26, 3.569D-26, 3.463D-26, 3.376D-26, 3.302D-26, 3.239D-26, 3.183D-26, 3.133D-26, 3.087D-26, 3.045D-26, &
3.007D-26, 2.970D-26, 2.935D-26, 2.902D-26, 2.871D-26, 2.840D-26, 2.810D-26, 2.781D-26, 2.752D-26, 2.724D-26, 2.697D-26, &
2.669D-26, 2.641D-26, 2.614D-26, 2.587D-26, 2.560D-26, 2.534D-26, 2.507D-26, 2.481D-26, 2.455D-26, 2.428D-26, 2.402D-26, &
2.375D-26, 2.347D-26, 2.319D-26, 2.291D-26, 2.261D-26, 2.230D-26, 2.198D-26, 2.163D-26, 2.126D-26, 2.086D-26, 2.041D-26, &
1.991D-26, 1.935D-26, 1.873D-26, 1.807D-26, 1.743D-26, 1.693D-26, 1.668D-26, 1.674D-26, 1.700D-26, 1.734D-26, 1.764D-26, &
1.785D-26, 1.798D-26, 1.804D-26, 1.804D-26, 1.800D-26, 1.792D-26, 1.783D-26, 1.772D-26, 1.760D-26, 1.748D-26, 1.735D-26, &
1.722D-26, 1.709D-26, 1.697D-26, 1.685D-26, 1.673D-26, 1.663D-26, 1.653D-26, 1.645D-26, 1.639D-26, 1.634D-26, 1.631D-26, &
1.631D-26, 1.634D-26, 1.640D-26, 1.651D-26, 1.666D-26, 1.687D-26, 1.715D-26, 1.752D-26, 1.799D-26, 1.858D-26, 1.931D-26, &
2.019D-26, 2.125D-26, 2.245D-26, 2.373D-26, 2.494D-26, 2.582D-26, 2.608D-26, 2.550D-26, 2.410D-26, 2.215D-26, 2.002D-26, &
1.800D-26, 1.626D-26, 1.484D-26, 1.374D-26, 1.293D-26, 1.238D-26, 1.206D-26, 1.198D-26, 1.216D-26, 1.265D-26, 1.355D-26, &
1.502D-26, 1.730D-26, 2.060D-26, 2.475D-26, 2.806D-26, 2.750D-26, 2.281D-26, 1.727D-26, 1.297D-26, 1.007D-26, 8.138D-27]

INTEGER                                    :: i, j
!~ REAL(double_precision), DIMENSION(nQabs)             :: Qdr


CALL compute_wlen(wlen)

!--------------------------------------------------------------------------
! --- Read the absorption efficiency Qabs for a 0.1 micrometer grain radius
!~ OPEN(20,FILE='../data/si_a1m1.dat', STATUS='unknown')
!~ READ(20,*)
!~ READ(20,*)
!~ DO i=1,nQabs
!~    READ(20,40) x1(i),Qdr(i)
!~ 40 FORMAT(2(ES9.3,1X))
!~ ENDDO
!~ CLOSE(20)

! --- Wavelength: micrometer to Angtroms
x1 = 1e4*x1

! --- Interpolate Qabs
Qabs=0.0D+00
DO i=1,nQabs-1
   DO j=1,nwlen
      IF(x1(i).ge.wlen(j) .AND. x1(i+1).lt. wlen(j)) THEN
         Qabs(j) = Qdr(i) + (wlen(j) - x1(i)) * &
            & ( Qdr(i+1) - Qdr(i))/( x1(i+1) - wlen(i))
      ENDIF
   ENDDO
ENDDO

!~ !--------------------------------------------------------------------------
!~ ! --- Read the dust emission from Draine & Li 2007 models
!~ OPEN(20,FILE='../data/U1.00_1.00_MW3.1_60.txt', STATUS='unknown')
!~ DO i = 1, 2
!~    READ(20,*)
!~ ENDDO
!~ 
!~ DO i = 1, ndustem
!~    READ(20,50) x2(i), Idustdr(i)
!~ 50 FORMAT(2(ES9.3,2X))
!~ ENDDO
!~ CLOSE(20)

! --- Interpolate Idustdr
Iinc_dust=0.0D+00
x2 = x2*1e4
DO i=ndustem-1,1,-1
   DO j=1,nwlen
      IF(x2(i).ge.wlen(j) .AND. x2(i+1).lt. wlen(j)) THEN
         Iinc_dust(j) = Idustdr(i) + (wlen(j) - x2(i)) * &
                  & ( Idustdr(i+1) - Idustdr(i))/( x2(i+1) - x2(i))
      ENDIF
   ENDDO
ENDDO

!--- From erg.s-1.H-1 to erg.cm-2.s-1.A-1.sr-1
Iinc_dust = Iinc_dust * 5.8e21/(wlen*4.0*pi)

END SUBROUTINE initial_tdust
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
SUBROUTINE compute_wlen(x)

!----
! This subroutine compute the wavelength in Angstrom



IMPLICIT NONE
INTEGER                        :: i
REAL(KIND=8), DIMENSION(nwlen) :: x

x = 911.76 *  exp(log(2.2e10/911.76)/nwlen)**(/ (i, i=0,nwlen-1) /)

END SUBROUTINE compute_wlen
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
SUBROUTINE compute_Iinc(x,Iout)



IMPLICIT NONE

REAL(KIND=8), DIMENSION(nwlen), INTENT(IN)    :: x
REAL(KIND=8)                                  :: Iin
REAL(KIND=8), DIMENSION(nwlen), INTENT(OUT)   :: Iout
INTEGER                                       :: i

Iout = 0.0
!OPEN(10,FILE="extinction_curve.dat",STATUS="UNKNOWN")
DO i=1,nwlen
   Iin = max(Iinc1(x(i)),Iinc2(x(i)),Iinc3(x(i)),Iinc_dust(i))
   Iout(i) = Iin * 10**(-ext(x(i))*visual_extinction/2.5)
!~    WRITE(10,*) x(i), ext(x(i))
ENDDO
!CLOSE(10)


END SUBROUTINE compute_Iinc
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
SUBROUTINE compute_abs(x,Iin,Q,dustabs)



IMPLICIT NONE
REAL(KIND=8), DIMENSION(nwlen), INTENT(IN)    :: x
REAL(KIND=8), DIMENSION(nwlen), INTENT(IN)    :: Iin
REAL(KIND=8), DIMENSION(nwlen), INTENT(IN)    :: Q
REAL(KIND=8), INTENT(OUT)                     :: dustabs
REAL(KIND=8), DIMENSION(nwlen)                :: Uin
REAL(KIND=8)                                  :: sigmabs
REAL(KIND=8)                                  :: test
REAL(KIND=8), DIMENSION(nwlen)                :: Utest
INTEGER :: i

! --- Convert the specific intensity into specific energy density
Uin = 4.0 * pi * Iin / SPEED_OF_LIGHT
!OPEN(10,FILE="ISRF.dat",STATUS="UNKNOWN")
!DO i =1,nwlen
!   WRITE(10,*), wlen(i), Uin(i)
!ENDDO
!CLOSE(10)

! --- Test: Compute the integrated energy density
Utest=0.0
DO i = 1,nwlen
   IF(x(i).ge.911.0 .AND. x(i).le. 2460.0) Utest(i) = Uin(i)
ENDDO

CALL trap_int(nwlen,x,Utest,test)
!~ WRITE(*,70), "ISRF from 912 to 2460 Angstroms = ", test,"erg.cm-3"
!~ 70   FORMAT(A35,2X,ES14.8,2X,A8)

CALL trap_int(nwlen,x,Uin,test)
!~ WRITE(*,70), "ISRF from 912 to 2E10 Angstroms = ", test,"erg.cm-3"
!---

! --- Compute the heating rate by absorption of radiation
CALL trap_int(nwlen,x,Uin*Q,sigmabs)
dustabs = sigmabs * pi * grain_radius**2 * SPEED_OF_LIGHT

END SUBROUTINE compute_abs
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
REAL(KIND=8)  FUNCTION get_ss_grain(Tss)



IMPLICIT NONE

REAL(KIND=8), INTENT(IN)                   :: Tss
REAL(KIND=8)                               :: rate_emi
REAL(KIND=8), DIMENSION(nwlen)             :: dustem
REAL(KIND=8)                               :: sigmaem
INTEGER :: i

! --- Compute the cooling rate by infrared emission
DO i = 1, nwlen
   dustem(i) = bbody(wlen(i),Tss)
ENDDO

CALL trap_int(nwlen,wlen,dustem*Qabs, sigmaem)
rate_emi = 4.0D+00 * pi**2 * grain_radius**2 * sigmaem

! --- cooling balance heating
get_ss_grain = rate_emi - rate_abs

END FUNCTION get_ss_grain
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
REAL(KIND=8) FUNCTION  Iinc1(x)
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!------------------------------------------------------------------------------
! 1st component
!   Local UV background between 912 and 2460 Angstroms (From Mathis et al. 1983)
!   The fit parameters come from "Physics of the ISM and IGM", Draine, 2011
!      - x in Angstroms
!      - starlight(x) in erg cm-2 s-1 Angstrom-1 sr-1
!------------------------------------------------------------------------------



IMPLICIT NONE

REAL (KIND = 8), INTENT (IN)      :: x          ! Wavelength (Angstrom)
REAL (KIND = 8)                   :: aux

IF (x .GE. 1340.0 .AND. x .LT. 2460.0) THEN
   Iinc1 = 2.373D-14 * (x/1e4)**(-0.6678)
ELSEIF (x .GE. 1100.0 .AND. x .LT. 1340.0) THEN
   Iinc1 = 6.825D-13*(x/1e4)
ELSEIF (x .GE. 912.0 .AND. x .LT. 1100.0) THEN
   Iinc1 = 1.287D-9 * (x/1e4)**(4.4172)
ELSE
   Iinc1 = 0.0D+00
ENDIF

Iinc1 = Iinc1*SPEED_OF_LIGHT/4.0D+00/pi/x*UV_FLUX

END FUNCTION Iinc1
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
REAL(KIND=8) FUNCTION  Iinc2(x)
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!------------------------------------------------------------------------------
! 2nd component
!   Starlight emmission from near-UV, visible and near-IR (From Mathis et al. 1983)
!   3 diluted Black Body (From Mathis et al. 1983)
!      - x in Angstroms
!      - starlight(x) in erg cm-2 s-1 Angstrom-1 sr-1
!------------------------------------------------------------------------------

IMPLICIT NONE

REAL (KIND = 8), INTENT (IN)      :: x          ! Wavelength (Angstrom)

Iinc2 =  1.0e-14*bbody(x,7500D+00) &
       + 1.0e-13*bbody(x,4000D+00) &
       + 4.0e-13*bbody(x,3000D+00)

END FUNCTION Iinc2
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
REAL(KIND=8) FUNCTION  Iinc3(x)
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!------------------------------------------------------------------------------
! 3rd component
!   CMB component at T=2.725 K
!      - x in Angstroms
!      - starlight(x) in erg cm-2 s-1 Angstrom-1 sr-1
!------------------------------------------------------------------------------

IMPLICIT NONE

REAL (KIND = 8), INTENT (IN)      :: x          ! Wavelength (Angstrom)


Iinc3 = bbody(x,2.725D+00)

END FUNCTION Iinc3
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
REAL(KIND=8) FUNCTION  bbody(x,T)
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!------------------------------------------------------------------------------
! Black body. x in Angstrom, T in K, bbody in erg cm-2 s-1 Angstrom-1 sr-1
!------------------------------------------------------------------------------



IMPLICIT NONE

REAL (KIND = 8), INTENT (IN)      :: x          ! Wavelength (Angstrom)
REAL (KIND = 8), INTENT (IN)      :: T          ! Temperature (K)

bbody = 2.0 * PLANCK_CONSTANT * SPEED_OF_LIGHT**2 * 1.0e32 / &
       (x**5 * (exp((PLANCK_CONSTANT*SPEED_OF_LIGHT/K_B)*1.0e8 / (x*T)) - 1.0))

END FUNCTION bbody
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
REAL(KIND=8) FUNCTION  ext(wl)
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
! Fit parameter from Cardelli et al. 1989 (1989ApJ...345..245C)
! -- The x range is optimized to have a smooth transition between each
!    components of the extinction curve

IMPLICIT NONE
REAL(KIND=8), INTENT(IN) :: wl
REAL(KIND=8) :: x
REAL(KIND=8) :: a, b, fa, fb,y

! convert x which is in Angstrom to micrometer-1
x = 1.0e4/wl

a = 0.0
b = 0.0
! --- Infrared: 0.0 to 1.4 micrometer-1
IF(x .lt. 1.4) THEN
   a =  0.574 * x**1.61
   b = -0.527 * x**1.61
! Optical/NIR: 1.4 to 2.7 micrometer-1
ELSEIF(x .ge. 1.4 .and. x .le. 2.7) THEN
  y = x - 1.82
  a = 1.00 + 0.17699*y - 0.50447*y**2 - 0.02427*y**3 + 0.72085*y**4 + &
      0.01979*y**5 - 0.77530*y**6 + 0.32999*y**7
  b = 1.41338*y + 2.28305*y**2 + 1.07233*y**3 - 5.38434*y**4 - &
      0.62251*y**5 + 5.30260*y**5 - 2.09002*y**7
! UV: 2.7 to 8.0 micrometer-1
ELSEIF(x .ge. 2.7 .and. x .le. 8.0) THEN
  IF(x .ge. 5.9 .and. x .le. 8.0) THEN
     fa = -0.04473*(x-5.9)**2 - 0.009779*(x-5.9)**3
     fb =  0.2130*(x-5.9)**2 + 0.1207*(x-5.9)**3
  ELSEIF(x .le. 5.9) THEN
     fa = 0.0
     fb = 0.0
  ENDIF
  a = 1.752 - 0.316*x - 0.104/((x-4.47)**2 + 0.341) + fa
  b = -3.090 + 1.825*x + 1.206/((x-4.62)**2 + 0.263) + fb
! Far-UV: 8.0 to ...  micrometer-1
ELSEIF(x .ge. 8.0) THEN
  a = -1.073 - 0.628*(x-8.0) + 0.137*(x-8.0)**2 - 0.070*(x-8.0)**3
  b = 13.670 + 4.257*(x-8.0) - 0.420*(x-8.0)**2 + 0.374*(x-8.0)**3
ENDIF

ext = a + b/3.1

END FUNCTION ext
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
SUBROUTINE trap_int(n,x,f,res)

IMPLICIT NONE
INTEGER :: i
REAL(KIND=8) :: h, int
REAL(KIND=8), INTENT(OUT) :: res
REAL(KIND=8),DIMENSION(n), INTENT(IN) :: x, f
INTEGER, INTENT(IN) :: n

res = 0.0
int = 0.0

DO i=1,n-1
h = abs((x(i+1) - x(i))/2.0)
int = h * (f(i) + f(i+1))
res = res + int
ENDDO

END SUBROUTINE trap_int
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
SUBROUTINE dicho(xl_in,xr_in,eps_in,xtry,ftry,etat)
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

IMPLICIT NONE

REAL(KIND=8), INTENT(IN)  :: xl_in, xr_in       ! Borne gauche et droite initiale
REAL(KIND=8), INTENT(IN)  :: eps_in             ! Precision
REAL(KIND=8)              :: xl, xr             ! Borne gauche et droite
REAL(KIND=8)              :: fl, fr             ! f(xl) et f(xr)
REAL(KIND=8), INTENT(OUT) :: xtry, ftry         ! Point milieu
INTEGER,       INTENT(OUT):: etat               ! Flag
REAL(KIND=8)              :: dxrel              ! Variation
INTEGER                   :: i                  ! Compteur
INTEGER ,      PARAMETER  :: imax = 10000
REAL(KIND=8) :: ss_grain

!--- Initialisation

xl = xl_in
xr = xr_in

fl = get_ss_grain(xl)
fr = get_ss_grain(xr)

!--- consistency test
IF (xl >= xr) THEN
   PRINT *, " Il faut xl < xr", xl, xr
   STOP
ENDIF

IF (fl*fr < 0.0D+00) THEN                       ! The zero is between xl and xr
   etat = 0                                     ! No solution found yet
   i    = 0
   DO WHILE (etat == 0)
      i = i + 1
      xtry = 0.5D+00 * (xl + xr)
      ftry = get_ss_grain(xtry)
      IF (fl*ftry > 0.0D+00) THEN
         xl = xtry
         fl = ftry
      ELSE
         xr = xtry
         fr = ftry
      ENDIF


      IF (xtry /= 0.0D+00) THEN
         dxrel = ABS((xr-xl)/xtry)
      ELSE
         dxrel = ABS(xr-xl)
      ENDIF
      IF (dxrel < eps_in .AND. ABS(ftry) < eps_in) THEN
         etat = 1
      ELSE IF (i > imax) THEN
         etat = 2
      ENDIF
   ENDDO

   !PRINT*, "Number of iter =",i

ELSE
   etat = 3
ENDIF

IF (etat == 3)THEN
   write(Error_unit,*) " "
   write(Error_unit,*) "--------------------------------------------------------  "
   write(Error_unit,*) " Error in subroutine DICHO of dust_temperature.f90:"
   write(Error_unit,*) " the sign of the function doesn't change in the interval:"
   write(Error_unit,*) " x(left)  :", xl," f(left)   :", fl
   write(Error_unit,*) " x(right) :", xr," f(right)  :", fr
   write(Error_unit,*) "--------------------------------------------------------  "
   write(Error_unit,*) " "
   call exit(11)
ENDIF

END SUBROUTINE dicho
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

end module dust_temperature